# Claude Auto-Prompt v1.2.0 - Release Notes

**Release Date**: December 19, 2025
**Version**: 1.2.0
**Status**: Stable

---

## What's New in v1.2.0?

### Fixed: Focus Loss Issue in Claude.ai Text Injection

Claude.ai recently updated their editor interface, which caused the extension to lose focus when injecting text. The prompt would fail to appear in the textarea because focus was being lost between character insertions.

**The Problem:**
- Claude.ai changed from a simple textarea to a ProseMirror-based contenteditable editor
- The old `textarea` selector no longer found the correct element
- Focus was being lost during the 150ms delays between character insertions
- The fallback `textarea.value += char` doesn't work for contenteditable elements

**The Solution:**
A complete rewrite of the text injection system with robust focus management.

---

## Technical Changes

### 1. Multi-Strategy Editor Detection

The extension now uses 6 different strategies to find the editor element:

```javascript
// Strategy 1: ProseMirror editor (most specific)
.ProseMirror[contenteditable="true"]

// Strategy 2: Contenteditable with placeholder
[contenteditable="true"][data-placeholder]

// Strategy 3: Fieldset-wrapped contenteditable
fieldset [contenteditable="true"]

// Strategy 4: Size-based detection (>200px width, >30px height)
// Strategy 5: Traditional textarea
// Strategy 6: Any contenteditable (fallback)
```

### 2. Click-to-Focus Activation

Before calling `.focus()`, the extension now simulates a full mouse interaction:

```javascript
function clickElement(element) {
  // Dispatch mousedown, mouseup, and click events
  const events = ['mousedown', 'mouseup', 'click'];
  events.forEach(eventType => {
    element.dispatchEvent(new MouseEvent(eventType, {
      bubbles: true,
      cancelable: true,
      view: window,
      clientX: x,
      clientY: y
    }));
  });
}
```

This activates any click handlers that set up focus state.

### 3. Focus Verification with Retry

The new `ensureFocus()` function verifies focus was actually acquired:

```javascript
function ensureFocus(element, maxAttempts = 3) {
  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
    element.focus();
    if (document.activeElement === element) {
      return true;
    }
    // Also check if focus is within element (for contenteditable)
    if (element.contains(document.activeElement)) {
      return true;
    }
  }
  return false;
}
```

### 4. Focus Maintenance During Injection

The key fix: **re-click and re-focus every 5 characters**:

```javascript
for (let i = 0; i < prompt.length; i++) {
  // Re-focus before each character
  if (i % 5 === 0) {
    clickElement(editor);
    await delay(50);
  }
  ensureFocus(editor);
  // ... insert character
}
```

### 5. Proper ContentEditable Text Insertion

New `insertTextIntoContentEditable()` function uses the Selection API:

- Sets cursor position using Range API
- Falls back through multiple insertion methods
- Dispatches proper InputEvent with `inputType: 'insertText'`

---

## Code Changes

| File | Lines Changed | Description |
|------|---------------|-------------|
| content.js | +342 / -116 | Complete rewrite of text injection |

### New Functions

| Function | Purpose |
|----------|---------|
| `findEditorElement()` | Multi-strategy editor detection |
| `clickElement()` | Simulates mouse click for activation |
| `ensureFocus()` | Focus verification with retry |
| `insertTextIntoContentEditable()` | Proper contenteditable text insertion |
| `insertTextIntoTextarea()` | Textarea-specific text insertion |

---

## Debugging

The extension now provides detailed console logs for debugging:

```
[findEditor] Found ProseMirror editor
[clickElement] Clicked element at 500, 300
[ensureFocus] Focus successful on attempt 1
[STEP 4] Progress: 10/50 characters
[STEP 4] Text injection complete. Content: "your prompt here"
```

Check the browser console (F12) for these logs if you encounter issues.

---

## Compatibility

### Tested With
- Chrome 120+
- Claude.ai (December 2025 version)
- ProseMirror-based contenteditable editor

### Backward Compatible
- Still supports traditional textarea elements
- Falls back gracefully through detection strategies
- Existing settings preserved

---

## Upgrading from v1.1.0

No action required. Simply:
1. Download the new version
2. Go to `chrome://extensions/`
3. Click the refresh icon next to Claude Auto-Prompt
4. The fix is automatically applied

Your existing settings (prompt, model, quiet hours) are preserved.

---

## Troubleshooting

### Text still not appearing?

1. **Check the console logs** (F12 â†’ Console tab)
   - Look for `[findEditor]` to see which strategy was used
   - Look for `[ensureFocus]` to verify focus acquisition
   - Look for `[STEP 4]` to track injection progress

2. **Verify the editor was found**
   - Should see: `[STEP 2] Found {type} editor`
   - If not found: Claude.ai may have changed their HTML structure again

3. **Check focus status**
   - Should see: `[ensureFocus] Focus successful on attempt X`
   - If failing: Try increasing the initial delay (currently 4 seconds)

### Report Issues

If the fix doesn't work for you:
1. Open browser console (F12)
2. Click "Test Now" in the extension popup
3. Copy all `[STEP X]` log messages
4. Open a GitHub issue with the logs

---

## What's Next?

Potential v1.3.0 features:
- [ ] Configurable retry attempts for focus
- [ ] Adjustable character injection delay
- [ ] Better error recovery and retry logic
- [ ] Support for other Claude interfaces

---

## Credits

**Developed by**: AL
**With help from**: Claude (AI pair programming)
**Issue reported by**: Community feedback

---

## Version Info

- **Version**: 1.2.0
- **Release**: December 19, 2025
- **Status**: Stable
- **License**: MIT (Open Source)

---

**Thank you for using Claude Auto-Prompt!**

This fix ensures reliable text injection even as Claude.ai's interface evolves.
